name: Regresi贸n Visual TN Sandbox Desktop

on:
  # Desencadena el flujo de trabajo manualmente
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N煤mero de Versi贸n (Ej: 170)'
        required: true
        default: '999'

# 1.  AADIDO: Permisos necesarios para el despliegue a GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write # Necesario para OIDC (OIDC para Pages)

jobs:
  # 猸锔 RENOMBRADO: run_regression ahora es 'build' (convenci贸n de Pages)
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 猬锔 Checkout del C贸digo
      uses: actions/checkout@v4

    # 1.  CORRECCIN CLAVE: Usar la acci贸n 'setup-chrome'
    # Esta acci贸n es m谩s robusta que apt-get e instala todas las dependencias necesarias.
    - name: 锔 Instalar Google Chrome Headless
      uses: browser-actions/setup-chrome@v1 # <--- CAMBIO AQU
      # run: |
      #   sudo apt-get update
      #   sudo apt-get install -y google-chrome-stable

    # 2. Configurar Python
    - name:  Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x' 

    # 3. Instalar dependencias de Python
    - name:  Instalar Dependencias
      run: |
        pip install --upgrade pip
        if [ -f requirements.txt ]; then
            pip install -r requirements.txt
        else
            echo "El archivo requirements.txt no se encontr贸."
            # Mantenemos el exit 1 si no encuentra dependencias
            exit 1
        fi

    # 4. Ejecutar el Script de Regresi贸n
    - name:  Ejecutar Regresi贸n Visual
      id: run_script
      run: |
        python regre_visual_tn_desk_sbx.py ${{ github.event.inputs.version_number }}
        
    # 猸锔 AADIDO (CRTICO): Renombrar el reporte a index.html
    # Esto soluciona el error 404 al asegurar que el archivo principal
    # se llame como GitHub Pages espera.
    - name:  Renombrar Reporte Principal a index.html
      run: |
        OUTPUT_DIR="Reportes HTML - TN - DESKTOP - SBX"
        # Busca el archivo HTML generado din谩micamente (Reporte_DOM_Estructural_v...html)
        REPORT_FILE=$(ls "$OUTPUT_DIR"/Reporte_DOM_Estructural_v*.html | head -n 1)
        # Mueve/Renombra el archivo principal a index.html
        mv "$REPORT_FILE" "$OUTPUT_DIR"/index.html
        
    # 5.  CAMBIO: Usar actions/upload-pages-artifact
    # Esta acci贸n empaqueta el directorio para el despliegue de Pages.
    - name:  Cargar Reportes como Artefacto para Pages
      uses: actions/upload-pages-artifact@v4
      with:
        # La ruta al directorio que contiene tu reporte HTML y tus im谩genes
        path: Reportes HTML - TN - DESKTOP - SBX
        
  # 2.  AADIDO: Job de Despliegue a GitHub Pages
  deploy:
    environment:
      # El nombre de entorno que se vincula con la configuraci贸n de GitHub Pages
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build # Asegura que este job espere a que el job 'build' termine
    steps:
      - name:  Desplegar a GitHub Pages
        id: deployment
        # La acci贸n que publica el artefacto previamente cargado
        uses: actions/deploy-pages@v4
